{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{% if edit_mode %}Editar Reporte Fotográfico{% else %}Nuevo Reporte Fotográfico{% endif %}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #92263f 0%, #62162c 100%);">
                    <h4 class="mb-0">
                        <i class="fas fa-camera me-2"></i>
                        {% if edit_mode %}Editar{% else %}Nuevo{% endif %} Reporte Fotográfico
                    </h4>
                </div>
                
                <div class="card-body">
                    {% if form.errors or foto_formset.errors %}
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Por favor corrija los siguientes errores:
                        <ul class="mb-0 mt-2">
                            {% for field in form %}
                                {% if field.errors %}
                                    <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
                                {% endif %}
                            {% endfor %}
                            {{ form.non_field_errors }}
                        </ul>
                    </div>
                    {% endif %}
                    
                    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Información General -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle me-2"></i>Información General
                            </h5>
                            
                            <div class="row g-3">
                                <!-- Campos ocultos -->
                                {{ form.proyecto }}
                                {{ form.tipo_formulario }}
                                
                                <div class="col-md-4">
                                    <label for="{{ form.fecha_emision.id_for_label }}" class="form-label">Fecha de Emisión</label>
                                    {{ form.fecha_emision|add_class:"form-control"|attr:"type:date" }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.reporte_numero.id_for_label }}" class="form-label">N° de Reporte</label>
                                    <input type="text" 
                                           name="reporte_numero" 
                                           id="reporte_numero_input" 
                                           class="form-control" 
                                           pattern="\d*" 
                                           title="Solo se permiten números"
                                           inputmode="numeric"
                                           {% if form.reporte_numero.value %}value="{{ form.reporte_numero.value }}"{% endif %}>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.version_reporte.id_for_label }}" class="form-label">Versión</label>
                                    <input type="text" 
                                           name="version_reporte" 
                                           id="version_reporte_input" 
                                           class="form-control" 
                                           pattern="\d*" 
                                           title="Solo se permiten números"
                                           inputmode="numeric"
                                           {% if form.version_reporte.value %}value="{{ form.version_reporte.value }}"{% endif %}>
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.cliente.id_for_label }}" class="form-label">Cliente</label>
                                    {{ form.cliente|add_class:"form-control"|attr:"readonly" }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.contratista.id_for_label }}" class="form-label">Contratista</label>
                                    {{ form.contratista|add_class:"form-control"|attr:"readonly" }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.codigo_proyecto.id_for_label }}" class="form-label">Código de Proyecto</label>
                                    {{ form.codigo_proyecto|add_class:"form-control"|attr:"readonly" }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.elaborado_por.id_for_label }}" class="form-label">Elaborado por</label>
                                    {{ form.elaborado_por|add_class:"form-control" }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.revisado_por.id_for_label }}" class="form-label">Revisado por</label>
                                    {{ form.revisado_por|add_class:"form-control" }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.inicio_supervision.id_for_label }}" class="form-label">Inicio de Supervisión</label>
                                    {{ form.inicio_supervision|add_class:"form-control"|attr:"type:date" }}
                                </div>
                                
                                <div class="col-md-4">
                                    <label for="{{ form.mes_actual_obra.id_for_label }}" class="form-label">Mes Actual de Obra</label>
                                    {{ form.mes_actual_obra|add_class:"form-control"|attr:"type:number" }}
                                </div>
                                
                                <div class="col-12">
                                    <label for="{{ form.descripcion.id_for_label }}" class="form-label">Descripción</label>
                                    {{ form.descripcion|add_class:"form-control"|attr:"rows:3" }}
                                    <div class="form-text">Descripción detallada del reporte.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección de Fotografías -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">
                                    <i class="fas fa-images me-2"></i>Fotografías
                                </h5>
                                <button type="button" class="btn btn-primary btn-sm" id="add-photo">
                                    <i class="fas fa-plus me-1"></i> Agregar Foto
                                </button>
                            </div>
                            
                            {{ foto_formset.management_form }}
                            <div id="photo-forms" class="row g-3">
                                {% for form in foto_formset %}
                                <div class="photo-form col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100">
                                        <div class="card-body p-0">
                                            <div class="photo-upload-area position-relative border-2 border-dashed rounded p-4 text-center h-100 d-flex flex-column justify-content-center" style="min-height: 200px;">
                                                <div class="upload-content">
                                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                    <h6 class="mb-1">Arrastra una imagen</h6>
                                                    <p class="small text-muted mb-2">o haz clic para seleccionar</p>
                                                    <p class="small text-muted">Formatos: JPG, PNG (Máx. 5MB)</p>
                                                </div>
                                                {{ form.imagen|add_class:"d-none file-input" }}
                                                <div class="preview-container d-none">
                                                    <img src="#" class="img-fluid rounded preview-image" style="max-height: 150px; width: 100%; object-fit: contain;">
                                                </div>
                                            </div>
                                            {% if form.instance.imagen %}
                                            <div class="current-image p-2 border-top">
                                                <small class="text-muted">Imagen actual:</small>
                                                <a href="{{ form.instance.imagen.url }}" target="_blank" class="d-block text-truncate" title="{{ form.instance.imagen.name }}">
                                                    <i class="far fa-image me-1"></i>{{ form.instance.imagen.name|slice:":30" }}...
                                                </a>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <div class="card-footer bg-transparent">
                                            <div class="mb-2">
                                                <label for="{{ form.descripcion.id_for_label }}" class="form-label small mb-1">Descripción</label>
                                                {{ form.descripcion|add_class:"form-control form-control-sm"|attr:"placeholder:Describa la fotografía..." }}
                                            </div>
                                            <button type="button" class="btn btn-outline-danger btn-sm w-100 remove-photo">
                                                <i class="fas fa-trash-alt me-1"></i> Eliminar
                                            </button>
                                        </div>
                                    </div>
                                    {{ form.id }}
                                    {{ form.DELETE|add_class:"d-none" }}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% if edit_mode %}{% url 'reportes:proyecto_detalle' reporte.proyecto.id %}{% else %}{% url 'reportes:proyecto_detalle' proyecto.id %}{% endif %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Cancelar
                            </a>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i> Guardar
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plantilla para nuevos formularios de fotos -->
<template id="photo-form-template">
    <div class="photo-form col-md-6 col-lg-4 mb-4">
        <div class="card h-100">
            <div class="card-body p-0">
                <div class="photo-upload-area position-relative border-2 border-dashed rounded p-4 text-center h-100 d-flex flex-column justify-content-center" style="min-height: 200px;">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h6 class="mb-1">Arrastra una imagen</h6>
                        <p class="small text-muted mb-2">o haz clic para seleccionar</p>
                        <p class="small text-muted">Formatos: JPG, PNG (Máx. 5MB)</p>
                    </div>
                    {{ foto_formset.empty_form.imagen|add_class:"d-none file-input" }}
                    <div class="preview-container d-none">
                        <img src="#" class="img-fluid rounded preview-image" style="max-height: 150px; width: 100%; object-fit: contain;">
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <div class="mb-2">
                    <label for="{{ foto_formset.empty_form.descripcion.id_for_label }}" class="form-label small mb-1">Descripción</label>
                    {{ foto_formset.empty_form.descripcion|add_class:"form-control form-control-sm"|attr:"placeholder:Describa la fotografía..." }}
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm w-100 remove-photo">
                    <i class="fas fa-trash-alt me-1"></i> Eliminar
                </button>
            </div>
        </div>
        {{ foto_formset.empty_form.id }}
        {{ foto_formset.empty_form.DELETE|add_class:"d-none" }}
    </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="{{ foto_formset.empty_form.descripcion.id_for_label }}" class="form-label">Descripción</label>
                    {{ foto_formset.empty_form.descripcion|add_class:"form-control"|attr:"placeholder:Describa la fotografía..." }}
                </div>
                <button type="button" class="btn btn-danger btn-sm remove-photo">
                    <i class="fas fa-trash me-1"></i> Eliminar
                </button>
            </div>
        </div>
        {{ foto_formset.empty_form.DELETE|add_class:"d-none" }}
    </div>
</template>
{% endblock %}

{% block extra_js %}
<style>
    .photo-upload-area {
        position: relative;
        transition: all 0.3s ease;
        cursor: pointer;
        background-color: #f8f9fa;
        border-color: #dee2e6 !important;
    }
    
    .photo-upload-area:hover {
        border-color: #6c757d !important;
        background-color: #f1f1f1;
    }
    
    .photo-upload-area.drag-over {
        background-color: #e9ecef;
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    }
    
    .preview-image {
        max-width: 100%;
        height: auto;
        object-fit: cover;
    }
    
    .remove-photo {
        transition: all 0.2s ease;
    }
    
    .remove-photo:hover {
        transform: translateY(-1px);
    }
    
    .current-image {
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
    }
</style>

<script>
    // Función para validar archivos
    function validateFile(file) {
        const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        if (!validTypes.includes(file.type)) {
            showToast('Solo se permiten archivos JPG o PNG', 'warning');
            return false;
        }
        
        if (file.size > maxSize) {
            showToast('El archivo es demasiado grande. Máximo 5MB', 'warning');
            return false;
        }
        
        return true;
    }
    
    // Función para mostrar notificaciones
    function showToast(message, type = 'info') {
        // Implementación simple de notificación
        alert(`${type.toUpperCase()}: ${message}`);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const addPhotoBtn = document.getElementById('add-photo');
        const photoForms = document.getElementById('photo-forms');
        const template = document.getElementById('photo-form-template');
        const totalForms = document.getElementById('id_fotos-TOTAL_FORMS');
        let formCount = document.querySelectorAll('.photo-form').length;
        const maxFiles = 20; // Límite máximo de imágenes
        
        // Inicializar eventos de arrastrar y soltar
        function initImageUpload(container) {
            const uploadArea = container.querySelector('.photo-upload-area');
            const fileInput = container.querySelector('input[type="file"]');
            const previewContainer = container.querySelector('.preview-container');
            const preview = container.querySelector('.preview-image');
            const uploadContent = container.querySelector('.upload-content');
            
            // Prevenir el comportamiento por defecto para los eventos de arrastrar
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            // Resaltar el área de soltado
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => highlight(uploadArea), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => unhighlight(uploadArea), false);
            });
            
            // Manejar la caída de archivos
            uploadArea.addEventListener('drop', handleDrop, false);
            
            // Click en el área de carga
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // Cambio en la selección de archivo
            fileInput.addEventListener('change', () => updatePreview(fileInput, preview, uploadArea, previewContainer, uploadContent));
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(element) {
                element.classList.add('drag-over');
            }
            
            function unhighlight(element) {
                element.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    if (validateFile(files[0])) {
                        fileInput.files = files;
                        updatePreview(fileInput, preview, uploadArea, previewContainer, uploadContent);
                    }
                }
            }
        }
        
        // Agregar nuevo formulario de foto
        addPhotoBtn.addEventListener('click', () => {
            // Verificar el límite de archivos
            if (formCount >= maxFiles) {
                showToast(`No se pueden agregar más de ${maxFiles} imágenes.`, 'warning');
                return;
            }
            
            const newForm = template.content.cloneNode(true);
            const newFormElement = newForm.firstElementChild;
            
            // Actualizar índices del formulario
            const formRegex = /fotos-(\d{1,})-/g;
            const replacement = `fotos-${formCount}-`;
            
            if (newFormElement.innerHTML) {
                newFormElement.innerHTML = newFormElement.innerHTML
                    .replace(formRegex, replacement);
            }
            
            // Agregar el nuevo formulario al contenedor
            photoForms.appendChild(newFormElement);
            
            // Inicializar eventos para el nuevo formulario
            initImageUpload(newFormElement);
            
            // Actualizar contador de formularios
            formCount++;
            totalForms.value = formCount;
        });
        
        // Eliminar formulario de foto
        document.addEventListener('click', (e) => {
            if (e.target.closest('.remove-photo')) {
                const formToRemove = e.target.closest('.photo-form');
                const deleteInput = formToRemove.querySelector('input[name$="-DELETE"]');
                
                if (deleteInput) {
                    // Si es un formulario existente, marcarlo para eliminación
                    deleteInput.value = 'on';
                    formToRemove.style.display = 'none';
                } else {
                    // Si es un nuevo formulario, eliminarlo directamente
                    formToRemove.remove();
                    // Actualizar índices de los formularios restantes
                    updateFormIndices();
                }
            }
        });
        
        // Actualizar índices de los formularios
        function updateFormIndices() {
            const forms = photoForms.querySelectorAll('.photo-form:not([style*="display: none"])');
            let index = 0;
            
            forms.forEach((form, i) => {
                Array.from(form.elements).forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/fotos-\d+-/, `fotos-${i}-`);
                        input.id = input.id.replace(/id_fotos-\d+-/, `id_fotos-${i}-`);
                    }
                });
                index = i;
            });
            
            totalForms.value = index + 1;
        }
        
        // Inicializar eventos para los formularios existentes
        document.querySelectorAll('.photo-form').forEach(form => {
            const uploadArea = form.querySelector('.photo-upload-area');
            const fileInput = form.querySelector('.file-input');
            const previewContainer = form.querySelector('.preview-container');
            const uploadContent = form.querySelector('.upload-content');
            const currentImage = form.querySelector('a[target="_blank"]');
            
            // Si hay una imagen existente, mostrarla
            if (currentImage) {
                const imgSrc = currentImage.getAttribute('href');
                const img = new Image();
                img.onload = function() {
                    if (previewContainer) {
                        const previewImg = previewContainer.querySelector('img');
                        if (previewImg) {
                            previewImg.src = imgSrc;
                            previewContainer.classList.remove('d-none');
                            if (uploadContent) uploadContent.classList.add('d-none');
                        }
                    }
                };
                img.src = imgSrc;
            }
            
            // Inicializar eventos de arrastrar y soltar
            if (uploadArea) {
                initImageUpload(form);
                
                // Si ya hay una imagen cargada, mostrar la vista previa
                if (fileInput.files && fileInput.files[0]) {
                    const preview = form.querySelector('.preview-image');
                    updatePreview(fileInput, preview, uploadArea, previewContainer, uploadContent);
                }
            }
        });
        
        // Función para actualizar la vista previa de la imagen
        function updatePreview(fileInput, preview, uploadArea, previewContainer, uploadContent) {
            console.log('Actualizando vista previa...');
            const file = fileInput.files[0];
            
            if (file) {
                console.log('Archivo seleccionado:', file.name, file.type, file.size);
                
                if (!validateFile(file)) {
                    console.log('Validación fallida');
                    fileInput.value = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    console.log('Imagen cargada, mostrando vista previa');
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    if (uploadContent) {
                        uploadContent.classList.add('d-none');
                    }
                    if (previewContainer) {
                        previewContainer.classList.remove('d-none');
                    }
                    if (uploadArea) {
                        uploadArea.style.border = '2px dashed #ccc';
                    }
                };
                
                reader.onerror = function(error) {
                    console.error('Error al cargar la imagen:', error);
                    showToast('Error al cargar la imagen', 'danger');
                    if (uploadContent) {
                        uploadContent.classList.remove('d-none');
                    }
                    if (previewContainer) {
                        previewContainer.classList.add('d-none');
                    }
                };
                
                reader.readAsDataURL(file);
            } else {
                console.log('No hay archivo seleccionado');
                if (preview) {
                    preview.src = '';
                    preview.style.display = 'none';
                }
                if (uploadContent) {
                    uploadContent.classList.remove('d-none');
                }
                if (previewContainer) {
                    previewContainer.classList.add('d-none');
                }
                if (uploadArea) {
                    uploadArea.style.border = '2px dashed #ccc';
                }
            }
        }
        
        // Inicializar eventos de arrastrar y soltar para formularios existentes
        document.querySelectorAll('.photo-form').forEach(form => {
            initImageUpload(form);
        });
        
        // Asegurarse de que el campo version_reporte sea editable
        const versionInput = document.getElementById('version_reporte_input');
        if (versionInput) {
            versionInput.removeAttribute('readonly');
            versionInput.removeAttribute('disabled');
            versionInput.classList.add('form-control');
        }
    });
</script>
</script>
{% endblock %}
